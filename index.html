<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>卡密激活</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=ZCOOL+KuaiLe&display=swap");

      :root {
        --bg: #0b1020;
        --bg-2: #11223f;
        --accent: #ff7a59;
        --accent-2: #36d1dc;
        --text: #f2f5ff;
        --muted: #b6c3e0;
        --card: rgba(255, 255, 255, 0.06);
        --border: rgba(255, 255, 255, 0.12);
        --shadow: 0 20px 60px rgba(5, 10, 25, 0.45);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        color: var(--text);
        font-family: "Noto Serif SC", "PingFang SC", "Microsoft YaHei", serif;
        background:
          radial-gradient(900px circle at 10% 10%, rgba(255, 122, 89, 0.18), transparent 60%),
          radial-gradient(800px circle at 90% 20%, rgba(54, 209, 220, 0.18), transparent 60%),
          linear-gradient(135deg, var(--bg) 0%, var(--bg-2) 100%);
        display: grid;
        place-items: center;
        padding: 32px 16px 48px;
      }

      .frame {
        width: min(980px, 100%);
        border: 1px solid var(--border);
        border-radius: 28px;
        background: var(--card);
        box-shadow: var(--shadow);
        padding: 36px 32px 40px;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        animation: appear 700ms ease-out both;
      }

      .contact-link {
        position: absolute;
        top: 18px;
        right: 22px;
        font-size: 13px;
        color: var(--muted);
        text-decoration: none;
        border: 1px solid var(--border);
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.04);
        transition: border 120ms ease, color 120ms ease, transform 120ms ease;
      }

      .contact-link:hover {
        color: var(--text);
        border-color: rgba(54, 209, 220, 0.6);
        transform: translateY(-1px);
      }

      .frame::before {
        content: "";
        position: absolute;
        inset: -50% -10%;
        background:
          repeating-linear-gradient(
            120deg,
            rgba(255, 255, 255, 0.03),
            rgba(255, 255, 255, 0.03) 2px,
            transparent 2px,
            transparent 6px
          );
        opacity: 0.4;
        pointer-events: none;
      }

      header {
        display: grid;
        gap: 12px;
        margin-bottom: 24px;
      }

      .badge {
        font-family: "ZCOOL KuaiLe", "Noto Serif SC", serif;
        letter-spacing: 2px;
        color: var(--accent-2);
        text-transform: uppercase;
        font-size: 14px;
      }

      h1 {
        margin: 0;
        font-size: clamp(28px, 5vw, 46px);
        line-height: 1.1;
      }

      .subtitle {
        color: var(--muted);
        font-size: 16px;
        max-width: 560px;
      }

      .panel {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        margin-top: 28px;
      }

      .card {
        padding: 22px;
        border-radius: 20px;
        background: rgba(10, 18, 36, 0.8);
        border: 1px solid var(--border);
        display: grid;
        gap: 14px;
        min-height: 210px;
        transform: translateY(16px);
        opacity: 0;
        animation: rise 700ms ease-out forwards;
      }

      .card:nth-child(2) {
        animation-delay: 120ms;
      }

      label {
        font-size: 14px;
        color: var(--muted);
      }

      input[type="text"] {
        width: 100%;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid transparent;
        border-radius: 12px;
        color: var(--text);
        padding: 14px 16px;
        font-size: 16px;
        outline: none;
        transition: border 150ms ease, box-shadow 150ms ease;
      }

      input[type="text"]:focus {
        border-color: rgba(255, 122, 89, 0.6);
        box-shadow: 0 0 0 3px rgba(255, 122, 89, 0.2);
      }

      .actions {
        display: grid;
        gap: 12px;
      }

      .tab-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
      }

      .tab-btn {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        color: var(--muted);
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 13px;
        cursor: pointer;
        transition: border 120ms ease, color 120ms ease;
      }

      .tab-btn.active {
        color: var(--text);
        border-color: rgba(54, 209, 220, 0.6);
      }

      .tab-panel {
        display: none;
        min-height: 620px;
      }

      .tab-panel.active {
        display: grid;
        gap: 14px;
      }

      #batchPanel.active {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .batch-input {
        width: 100%;
        min-height: 140px;
        resize: vertical;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid transparent;
        border-radius: 12px;
        color: var(--text);
        padding: 14px 16px;
        font-size: 14px;
        outline: none;
        transition: border 150ms ease, box-shadow 150ms ease;
      }

      .batch-input:focus {
        border-color: rgba(255, 122, 89, 0.6);
        box-shadow: 0 0 0 3px rgba(255, 122, 89, 0.2);
      }

      .batch-results {
        display: grid;
        gap: 6px;
      }

      .batch-scroll {
        display: block;
        height: 240px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .batch-row {
        display: grid;
        grid-template-columns: 1.6fr 0.8fr 0.7fr;
        gap: 12px;
        align-items: center;
        padding: 0 10px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid var(--border);
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 13px;
        height: 40px;
      }

      .batch-head {
        color: var(--muted);
        font-family: "Noto Serif SC", "PingFang SC", "Microsoft YaHei", serif;
        font-size: 12px;
        background: rgba(11, 16, 32, 0.6);
        border: none;
        padding: 0 10px;
        height: 40px;
        align-items: center;
      }

      .batch-rows {
        display: grid;
        gap: 2px;
        align-content: start;
      }

      .batch-empty {
        color: var(--muted);
        font-size: 13px;
        text-align: center;
        padding: 10px 0;
      }

      .batch-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin-top: auto;
      }

      .btn {
        border: none;
        border-radius: 14px;
        padding: 12px 16px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
        color: #101425;
        background: linear-gradient(135deg, var(--accent), #ffc371);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }

      .btn.compact {
        height: 44px;
        padding: 0 16px;
        line-height: 44px;
        white-space: nowrap;
      }

      .btn.secondary {
        color: #04141b;
        background: linear-gradient(135deg, var(--accent-2), #7fffd4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 30px rgba(255, 122, 89, 0.25);
      }

      .btn.secondary:not(:disabled):hover {
        box-shadow: 0 14px 30px rgba(54, 209, 220, 0.25);
      }

      .status-line {
        font-size: 14px;
        color: var(--muted);
        text-align: center;
        margin-top: 16px;
      }

      .result {
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        background: rgba(7, 12, 24, 0.8);
        border-radius: 16px;
        padding: 16px;
        border: 1px solid var(--border);
        overflow: auto;
        min-height: 180px;
        color: #dce6ff;
      }

      .hidden {
        display: none;
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
      }

      .billing {
        display: grid;
        gap: 12px;
      }

      .billing .btn.secondary {
        width: 100%;
      }

      .info-list {
        display: grid;
        gap: 12px;
      }

      .info-row {
        display: grid;
        grid-template-columns: 90px 1fr auto;
        gap: 12px;
        align-items: center;
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid var(--border);
      }

      .info-row.hidden-row {
        display: none;
      }

      .info-label {
        font-size: 12px;
        color: var(--muted);
      }

      .info-value {
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 14px;
        word-break: break-all;
      }

      .copy-mini {
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        border-radius: 10px;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
        transition: border 120ms ease, transform 120ms ease;
      }

      .copy-mini:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .copy-mini:not(:disabled):hover {
        border-color: rgba(54, 209, 220, 0.6);
        transform: translateY(-1px);
      }

      .tips {
        margin: 0;
        padding-left: 18px;
        color: var(--muted);
        font-size: 14px;
      }

      .tips li {
        margin-bottom: 8px;
      }

      @keyframes rise {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes appear {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 640px) {
        .frame {
          padding: 28px 20px 32px;
        }

        .panel {
          grid-template-columns: 1fr;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
        }
      }
    </style>
  </head>
  <body>
    <main class="frame">
      <a class="contact-link" href="https://t.me/faithcut" target="_blank" rel="noreferrer">
        联系客服：@faithcut
      </a>
      <header>
        
        <h1>卡密查询 / 激活</h1>
        <div class="subtitle">
          查询当前卡密状态或直接激活，激活后一小时有效，过期不退。
        </div>
      </header>

      <section class="panel">
        <div class="card">
          <div class="tab-bar">
            <button class="tab-btn active" data-tab="single">单卡激活</button>
            <button class="tab-btn" data-tab="batch">批量激活</button>
          </div>
          <div class="tab-panel active" id="singlePanel">
            <div>
              <input id="keyInput" type="text" placeholder="请输入卡密" />
            </div>
            <div class="actions">
              <button class="btn" id="actionBtn">激活/查询</button>
            </div>
            <div class="card-title">卡片信息</div>
            <div class="info-list" id="infoList">
              <div class="info-row">
                <div class="info-label">卡号</div>
                <div class="info-value" id="cardNumber">-</div>
                <button class="copy-mini" data-field="cardNumber">复制</button>
              </div>
              <div class="info-row">
                <div class="info-label">安全码</div>
                <div class="info-value" id="cardCvv">-</div>
                <button class="copy-mini" data-field="cardCvv">复制</button>
              </div>
              <div class="info-row">
                <div class="info-label">有效期</div>
                <div class="info-value" id="cardExp">-</div>
                <button class="copy-mini" data-field="cardExp">复制</button>
              </div>
              <div class="info-row">
                <div class="info-label">卡片余额</div>
                <div class="info-value" id="cardBalance">-</div>
                <button class="copy-mini" data-field="cardBalance">复制</button>
              </div>
            <div class="info-row hidden-row reveal-row">
              <div class="info-label">激活时间</div>
              <div class="info-value" id="cardActivated">-</div>
              <button class="copy-mini" data-field="cardActivated">复制</button>
            </div>
            <div class="info-row hidden-row reveal-row">
              <div class="info-label">到期时间</div>
              <div class="info-value" id="cardExpireTime">-</div>
              <button class="copy-mini" data-field="cardExpireTime">复制</button>
            </div>
          </div>
            <button class="btn secondary" id="copyAllBtn" disabled>
              复制全部信息
            </button>
            <pre class="result hidden" id="resultBox">{}</pre>
          </div>
          <div class="tab-panel" id="batchPanel">
            <div>
              <textarea
                id="batchInput"
                class="batch-input"
                placeholder="一行输入一个卡密，可输入多行"
              ></textarea>
            </div>
            <div class="actions">
              <button class="btn compact" id="batchBtn">批量激活</button>
            </div>
            <div class="card-title">批量卡片信息</div>
            <div class="batch-results" id="batchResults">
              <div class="batch-row batch-head">
                <div>卡号</div>
                <div>有效期</div>
                <div>安全码</div>
              </div>
              <div class="batch-scroll">
                <div class="batch-rows" id="batchRows"></div>
                <div class="batch-empty" id="batchEmpty">暂无结果</div>
              </div>
            </div>
            <div class="batch-actions">
              <button class="btn secondary compact" id="batchCopyBtn" disabled>
                一键复制结果
              </button>
              <button class="btn secondary compact" id="batchExportBtn" disabled>
                一键导出结果
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="billing">
            <div class="card-title">账单地址</div>
            <div class="info-list" id="billingList">
              <div class="info-row">
                <div class="info-label">姓名</div>
                <div class="info-value" id="billName">Donald Smith</div>
                <button class="copy-mini" data-bill="billName">复制</button>
              </div>
              <div class="info-row">
                <div class="info-label">街道地址1</div>
                <div class="info-value" id="billStreet">41 Glenn Rd C23</div>
                <button class="copy-mini" data-bill="billStreet">复制</button>
              </div>
              <div class="info-row">
                <div class="info-label">街道地址2</div>
                <div class="info-value" id="billStreet2">无</div>
                <button class="copy-mini" data-bill="billStreet2">复制</button>
              </div>
              <div class="info-row">
                <div class="info-label">城市</div>
                <div class="info-value" id="billCity">East Hartford</div>
                <button class="copy-mini" data-bill="billCity">复制</button>
              </div>
              <div class="info-row">
                <div class="info-label">州</div>
                <div class="info-value" id="billState">Connecticut</div>
                <button class="copy-mini" data-bill="billState">复制</button>
              </div>
              <div class="info-row">
                <div class="info-label">邮编</div>
                <div class="info-value" id="billZip">06118</div>
                <button class="copy-mini" data-bill="billZip">复制</button>
              </div>
              <div class="info-row">
                <div class="info-label">国家</div>
                <div class="info-value" id="billCountry">美国</div>
                <button class="copy-mini" data-bill="billCountry">复制</button>
              </div>
            </div>
            <button class="btn secondary" id="copyBillingBtn">复制账单地址</button>
          </div>
        </div>
      </section>
      <div class="status-line" id="statusText">等待输入卡密...</div>
    </main>

    <script>
      const endpoints = {
        query: "/api/keys/query",
        redeem: "/api/keys/redeem",
      };

      const keyInput = document.getElementById("keyInput");
      const actionBtn = document.getElementById("actionBtn");
      const batchInput = document.getElementById("batchInput");
      const batchBtn = document.getElementById("batchBtn");
      const statusText = document.getElementById("statusText");
      const resultBox = document.getElementById("resultBox");
      const copyAllBtn = document.getElementById("copyAllBtn");
      const infoList = document.getElementById("infoList");
      const revealRows = document.querySelectorAll(".reveal-row");
      const tabButtons = document.querySelectorAll(".tab-btn");
      const singlePanel = document.getElementById("singlePanel");
      const batchPanel = document.getElementById("batchPanel");
      const batchRows = document.getElementById("batchRows");
      const batchEmpty = document.getElementById("batchEmpty");
      const batchCopyBtn = document.getElementById("batchCopyBtn");
      const batchExportBtn = document.getElementById("batchExportBtn");
      const billingList = document.getElementById("billingList");
      const copyBillingBtn = document.getElementById("copyBillingBtn");
      const cardNumber = document.getElementById("cardNumber");
      const cardCvv = document.getElementById("cardCvv");
      const cardExp = document.getElementById("cardExp");
      const cardBalance = document.getElementById("cardBalance");
      const cardActivated = document.getElementById("cardActivated");
      const cardExpireTime = document.getElementById("cardExpireTime");
      const billName = document.getElementById("billName");
      const billStreet = document.getElementById("billStreet");
      const billStreet2 = document.getElementById("billStreet2");
      const billCity = document.getElementById("billCity");
      const billState = document.getElementById("billState");
      const billZip = document.getElementById("billZip");
      const billCountry = document.getElementById("billCountry");

      const fieldLabels = {
        cardNumber: "卡号",
        cardCvv: "安全码",
        cardExp: "有效期",
        cardBalance: "卡片余额",
        cardActivated: "激活时间",
        cardExpireTime: "到期时间",
      };

      const fieldValues = {
        cardNumber: "-",
        cardCvv: "-",
        cardExp: "-",
        cardBalance: "-",
        cardActivated: "-",
        cardExpireTime: "-",
      };

      const billingLabels = {
        billName: "姓名",
        billStreet: "街道地址1",
        billStreet2: "街道地址2",
        billCity: "城市",
        billState: "州",
        billZip: "邮编",
        billCountry: "国家",
      };

      const billingValues = {
        billName: "Donald Smith",
        billStreet: "41 Glenn Rd C23",
        billStreet2: "无",
        billCity: "East Hartford",
        billState: "Connecticut",
        billZip: "06118",
        billCountry: "美国",
      };

      let batchSummaries = [];
      let copyAllUnlockCount = 0;
      let copyAllUnlocked = false;

      const setLoading = (isLoading, label) => {
        actionBtn.disabled = isLoading;
        statusText.textContent = isLoading ? label : "等待输入卡密...";
      };

      const setBatchLoading = (isLoading, label) => {
        batchBtn.disabled = isLoading;
        statusText.textContent = isLoading ? label : "等待输入卡密...";
      };

      const handleCopyAllUnlock = () => {
        if (copyAllUnlocked) return;
        copyAllUnlockCount += 1;
        if (copyAllUnlockCount >= 3) {
          copyAllUnlocked = true;
          revealRows.forEach((row) => row.classList.remove("hidden-row"));
        }
      };

      const resetCopyAllUnlock = () => {
        if (copyAllUnlocked) return;
        copyAllUnlockCount = 0;
      };

      const requestApi = async (type, keyId) => {
        const response = await fetch(endpoints[type], {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ key_id: keyId }),
        });

        const data = await response.json().catch(() => null);
        const payload = data ?? { error: "响应不是 JSON 格式" };
        return { response, payload };
      };

      const isApiSuccess = (response, payload) =>
        response.ok && (payload.success === undefined || payload.success === true);

      const formatCardNumber = (value) => {
        if (!value) return "-";
        const clean = String(value).replace(/\s+/g, "");
        return clean.replace(/(.{4})/g, "$1 ").trim();
      };

      const formatExpireLabel = (month, year) => {
        if (!month || !year) return "-";
        const mm = String(month).padStart(2, "0");
        const yy = String(year).slice(-2);
        return `${mm}月/${yy}年`;
      };

      const formatExpirePlain = (month, year) => {
        if (!month || !year) return "-";
        const mm = String(month).padStart(2, "0");
        const yy = String(year).slice(-2);
        return `${mm}/${yy}`;
      };

      const formatTimestamp = (value) => {
        if (!value) return "-";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return String(value);
        const pad = (num) => String(num).padStart(2, "0");
        return `${date.getFullYear()}/${pad(date.getMonth() + 1)}/${pad(
          date.getDate()
        )} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(
          date.getSeconds()
        )}`;
      };

      const formatBalance = (value) => {
        if (value === undefined || value === null || value === "") return "-";
        const numeric = Number(value);
        if (!Number.isNaN(numeric)) return `$${numeric}`;
        return String(value);
      };

      const deriveExpireTime = (payload, card) => {
        if (card && card.expire_time) return card.expire_time;
        if (payload && payload.expire_time) return payload.expire_time;
        if (payload && payload.used_time && payload.expire_minutes) {
          const base = new Date(payload.used_time);
          const minutes = Number(payload.expire_minutes);
          if (!Number.isNaN(base.getTime()) && !Number.isNaN(minutes)) {
            return new Date(base.getTime() + minutes * 60000).toISOString();
          }
        }
        return payload ? payload.used_time : "";
      };

      const updateField = (key, value, element) => {
        fieldValues[key] = value || "-";
        element.textContent = fieldValues[key];
      };

      const refreshCopyState = () => {
        const hasAny = Object.values(fieldValues).some(
          (value) => value && value !== "-"
        );
        copyAllBtn.disabled = !hasAny;
        infoList.querySelectorAll(".copy-mini").forEach((btn) => {
          const key = btn.dataset.field;
          const value = fieldValues[key];
          btn.disabled = !value || value === "-";
        });
      };

      const updateCardInfo = (payload) => {
        const card =
          payload && typeof payload === "object"
            ? payload.card || (payload.data && payload.data.card) || null
            : null;
        const pan =
          (card && (card.pan || card.card_number)) ||
          (payload && (payload.pan || payload.card_number)) ||
          "";
        const cvc =
          (card && (card.cvv || card.cvc)) ||
          (payload && (payload.cvv || payload.cvc)) ||
          "";
        const exp = formatExpireLabel(
          (card && card.exp_month) || (payload && payload.exp_month),
          (card && card.exp_year) || (payload && payload.exp_year)
        );
        const balanceValue =
          (card && card.card_limit) ||
          (payload && payload.card_limit) ||
          (payload && payload.balance) ||
          (payload && payload.card_balance) ||
          "";
        const activatedValue =
          (payload && (payload.used_time || payload.activated_time)) ||
          (payload && payload.activation_time) ||
          (payload && payload.redeem_time) ||
          "";
        const expireTimeValue = deriveExpireTime(payload, card);

        updateField("cardNumber", formatCardNumber(pan), cardNumber);
        updateField("cardCvv", cvc || "-", cardCvv);
        updateField("cardExp", exp, cardExp);
        updateField("cardBalance", formatBalance(balanceValue), cardBalance);
        updateField(
          "cardActivated",
          formatTimestamp(activatedValue),
          cardActivated
        );
        updateField(
          "cardExpireTime",
          formatTimestamp(expireTimeValue),
          cardExpireTime
        );

        refreshCopyState();
      };

      const extractCardSummary = (payload) => {
        const card =
          payload && typeof payload === "object"
            ? payload.card || (payload.data && payload.data.card) || null
            : null;
        const pan =
          (card && (card.pan || card.card_number)) ||
          (payload && (payload.pan || payload.card_number)) ||
          "";
        const cvc =
          (card && (card.cvv || card.cvc)) ||
          (payload && (payload.cvv || payload.cvc)) ||
          "";
        const exp = formatExpirePlain(
          (card && card.exp_month) || (payload && payload.exp_month),
          (card && card.exp_year) || (payload && payload.exp_year)
        );
        return {
          pan: formatCardNumber(pan),
          exp,
          cvc: cvc || "-",
        };
      };

      const initBillingInfo = () => {
        billName.textContent = billingValues.billName;
        billStreet.textContent = billingValues.billStreet;
        billStreet2.textContent = billingValues.billStreet2;
        billCity.textContent = billingValues.billCity;
        billState.textContent = billingValues.billState;
        billZip.textContent = billingValues.billZip;
        billCountry.textContent = billingValues.billCountry;
      };

      const callApi = async () => {
        const keyId = keyInput.value.trim();
        if (!keyId) {
          statusText.textContent = "请先输入卡密。";
          return;
        }

        setLoading(true, "激活/查询中...");
        resultBox.textContent = "请求发送中...";

        try {
          const finalResult = await runActivation(keyId);
          resultBox.textContent = JSON.stringify(
            {
              ok: finalResult.response.ok,
              status: finalResult.response.status,
              data: finalResult.payload,
            },
            null,
            2
          );
          statusText.textContent = finalResult.success
            ? `${finalResult.actionLabel}完成。`
            : `${finalResult.actionLabel}失败，请检查卡密或接口状态。`;
          updateCardInfo(finalResult.payload);
        } catch (error) {
          resultBox.textContent = JSON.stringify(
            { ok: false, error: error.message || "网络错误" },
            null,
            2
          );
          statusText.textContent = "网络请求失败，请稍后再试。";
          updateCardInfo(null);
        } finally {
          setLoading(false, "完成");
        }
      };

      const runActivation = async (keyId) => {
        const primary = await requestApi("redeem", keyId);
        let finalResult = primary;
        let actionLabel = "激活";
        let success = isApiSuccess(primary.response, primary.payload);

        if (!success) {
          const fallback = await requestApi("query", keyId);
          const fallbackSuccess = isApiSuccess(
            fallback.response,
            fallback.payload
          );
          if (fallbackSuccess || fallback.response.ok) {
            finalResult = fallback;
            actionLabel = "查询";
            success = fallbackSuccess;
          }
        }

        return {
          response: finalResult.response,
          payload: finalResult.payload,
          success,
          actionLabel,
        };
      };

      const clearBatchRows = () => {
        batchRows.innerHTML = "";
        batchEmpty.classList.remove("hidden");
        batchSummaries = [];
        batchCopyBtn.disabled = true;
        batchExportBtn.disabled = true;
      };

      const renderBatchRow = (summary) => {
        const row = document.createElement("div");
        row.className = "batch-row";
        const pan = document.createElement("div");
        pan.textContent = summary.pan || "-";
        const exp = document.createElement("div");
        exp.textContent = summary.exp || "-";
        const cvc = document.createElement("div");
        cvc.textContent = summary.cvc || "-";
        row.append(pan, exp, cvc);
        batchRows.append(row);
        batchEmpty.classList.add("hidden");
        batchSummaries.push(summary);
        batchCopyBtn.disabled = false;
        batchExportBtn.disabled = false;
      };

      const runBatchActivation = async () => {
        const keys = batchInput.value
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter(Boolean);

        if (!keys.length) {
          statusText.textContent = "请先输入卡密。";
          return;
        }

        clearBatchRows();
        setBatchLoading(true, `批量激活中 (0/${keys.length})...`);

        try {
          for (let i = 0; i < keys.length; i += 1) {
            statusText.textContent = `批量激活中 (${i + 1}/${keys.length})...`;
            const result = await runActivation(keys[i]);
            const summary = extractCardSummary(result.payload);
            renderBatchRow(summary);
            if (i < keys.length - 1) {
              await new Promise((resolve) => setTimeout(resolve, 3000));
            }
          }
          batchEmpty.classList.add("hidden");
          statusText.textContent = "批量激活完成。";
        } catch (error) {
          statusText.textContent = "批量激活失败，请稍后再试。";
        } finally {
          setBatchLoading(false, "完成");
        }
      };

      actionBtn.addEventListener("click", () => {
        resetCopyAllUnlock();
        callApi();
      });
      batchBtn.addEventListener("click", () => {
        resetCopyAllUnlock();
        runBatchActivation();
      });
      batchCopyBtn.addEventListener("click", async () => {
        resetCopyAllUnlock();
        if (!batchSummaries.length) return;
        const lines = batchSummaries.map(
          (item) => `${item.pan || "-"}\t${item.exp || "-"}\t${item.cvc || "-"}`
        );
        try {
          await navigator.clipboard.writeText(lines.join("\n"));
          statusText.textContent = "批量结果已复制。";
        } catch (error) {
          statusText.textContent = "复制失败，请手动复制。";
        }
      });
      batchExportBtn.addEventListener("click", () => {
        resetCopyAllUnlock();
        if (!batchSummaries.length) return;
        const escapeCsv = (value) => {
          const text = String(value ?? "");
          if (/[",\n]/.test(text)) {
            return `"${text.replace(/"/g, '""')}"`;
          }
          return text;
        };
        const rows = [
          ["卡号", "有效期", "安全码"],
          ...batchSummaries.map((item) => [
            item.pan || "",
            item.exp || "",
            item.cvc || "",
          ]),
        ];
        const csvContent = rows.map((row) => row.map(escapeCsv).join(",")).join("\n");
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `batch-cards-${Date.now()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        statusText.textContent = "批量结果已导出。";
      });
      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          resetCopyAllUnlock();
          const target = button.dataset.tab;
          tabButtons.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");
          if (target === "batch") {
            singlePanel.classList.remove("active");
            batchPanel.classList.add("active");
          } else {
            batchPanel.classList.remove("active");
            singlePanel.classList.add("active");
          }
        });
      });
      infoList.addEventListener("click", async (event) => {
        const button = event.target.closest(".copy-mini");
        if (!button) return;
        const key = button.dataset.field;
        const value = fieldValues[key];
        if (!value || value === "-") return;
        resetCopyAllUnlock();
        try {
          await navigator.clipboard.writeText(value);
          statusText.textContent = "已复制。";
        } catch (error) {
          statusText.textContent = "复制失败，请手动复制。";
        }
      });

      billingList.addEventListener("click", async (event) => {
        const button = event.target.closest(".copy-mini");
        if (!button) return;
        const key = button.dataset.bill;
        const value = billingValues[key];
        if (value === undefined || value === null) return;
        resetCopyAllUnlock();
        try {
          await navigator.clipboard.writeText(value);
          statusText.textContent = "已复制。";
        } catch (error) {
          statusText.textContent = "复制失败，请手动复制。";
        }
      });

      copyAllBtn.addEventListener("click", async () => {
        handleCopyAllUnlock();
        const lines = Object.keys(fieldValues)
          .map((key) => {
            const value = fieldValues[key];
            if (!value || value === "-") return "";
            return `${fieldLabels[key]}：${value}`;
          })
          .filter(Boolean);
        if (!lines.length) return;
        try {
          await navigator.clipboard.writeText(lines.join("\n"));
          statusText.textContent = "全部卡片信息已复制。";
        } catch (error) {
          statusText.textContent = "复制失败，请手动复制。";
        }
      });

      copyBillingBtn.addEventListener("click", async () => {
        resetCopyAllUnlock();
        const lines = Object.keys(billingValues).map(
          (key) => `${billingLabels[key]}：${billingValues[key]}`
        );
        try {
          await navigator.clipboard.writeText(lines.join("\n"));
          statusText.textContent = "账单地址已复制。";
        } catch (error) {
          statusText.textContent = "复制失败，请手动复制。";
        }
      });

      initBillingInfo();
      updateCardInfo(null);
    </script>
  </body>
</html>
